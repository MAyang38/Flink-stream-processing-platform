package bishe.utils;

import bishe.function.processfunction.distanceCalculateRichMapFunction;
import bishe.function.sink.HBaseSink;
import bishe.function.sink.JDBCSinkCarLocation;
import bishe.function.source.SourceFromMySQL;
import bishe.model.Car;
import bishe.model.CarLocationInfo;
import bishe.model.Point;
import bishe.watermark.DistancePeriodicGenerator;
import org.apache.flink.api.common.eventtime.WatermarkStrategy;
import org.apache.flink.api.common.state.ValueState;
import org.apache.flink.api.common.state.ValueStateDescriptor;
import org.apache.flink.api.common.typeinfo.TypeInformation;
import org.apache.flink.api.java.tuple.Tuple4;
import org.apache.flink.configuration.Configuration;
import org.apache.flink.streaming.api.TimeCharacteristic;
import org.apache.flink.streaming.api.datastream.DataStreamSource;
import org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;
import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
import org.apache.flink.streaming.api.functions.windowing.ProcessWindowFunction;
import org.apache.flink.streaming.api.windowing.assigners.TumblingEventTimeWindows;
import org.apache.flink.streaming.api.windowing.time.Time;
import org.apache.flink.streaming.api.windowing.windows.TimeWindow;
import org.apache.flink.util.Collector;

import java.util.*;

public class carCurrentLocation {

//[new Point(106.93328130522411,39.47386315244423), new Point(106.93528591389676,39.47308331359599), new Point(106.93558002636611,39.47234545795724), new Point(106.93547166914055,39.47073774518093), new Point(106.9353913188517,39.470431795597676), new Point(106.93582483034564,39.469644322307936), new Point(106.9365670736119,39.4683526664651), new Point(106.9367500924995,39.467012865038235), new Point(106.9375533420616,39.46646117453912), new Point(106.93967157860747,39.46445823047036), new Point(106.94313265779039,39.465028145693694), new Point(106.94430974405509,39.46563321920717), new Point(106.94447081901762,39.46854326058364), new Point(106.94432213443682,39.46923786471333), new Point(106.94382651916747,39.46989091987866), new Point(106.94301419554338,39.471726827036115), new Point(106.94275399752698,39.47358987148918), new Point(106.94080971381513,39.47393747936455), new Point(106.94015302358324,39.47395668564973), new Point(106.93959545640523,39.47434081023106), new Point(106.93460105434576,39.47441544303832), new Point(106.93349831037146,39.47424258742824)]
//            [new Point(106.9445581367628,39.46553978194375), new Point(106.94457077701112,39.46583372115703), new Point(106.94468949570219,39.46825747067865), new Point(106.94455523527796,39.46923576392724), new Point(106.94342344555764,39.47190477444357), new Point(106.94356079521695,39.47359836788914), new Point(106.94936072366787,39.473956103776274), new Point(106.95378935879339,39.473449303851694), new Point(106.95717771050015,39.47256751203145), new Point(106.95806938200192,39.4690888767586), new Point(106.95673187474925,39.465909573308195), new Point(106.95479731001649,39.464408652893816), new Point(106.94876366618776,39.46415521834356), new Point(106.94469169966294,39.465399342663204)]
//            [new Point(106.9334049552812,39.470530834676794), new Point(106.93354675275577,39.469585642519625), new Point(106.93390124644218,39.46786008391867), new Point(106.93479457053189,39.46806891177621), new Point(106.93500726674374,39.46816783001452), new Point(106.93490800851154,39.468563501550236), new Point(106.93476621103699,39.469420782096755), new Point(106.93461023381496,39.47050885361083), new Point(106.93459542740506,39.47058791229157), new Point(106.93400586054396,39.470581091918795), new Point(106.93344855853596,39.47056972462934), new Point(106.93340749417747,39.47056063079642)]
//            [new Point(106.94022939015291,39.47474585684117), new Point(106.94037848760337,39.47408718240309), new Point(106.94070650199441,39.47404673727657), new Point(106.94095251278769,39.474220073366126), new Point(106.94106433587555,39.47457829990489), new Point(106.94078105071965,39.47476896811081), new Point(106.94040830709346,39.47479785718694), new Point(106.94028157426057,39.47474007902256)]
//            [new Point(106.92520965567516,39.47603722956842), new Point(106.92388318505208,39.47679473408092), new Point(106.92297559988891,39.47690294833247), new Point(106.92048555854383,39.47585687012555), new Point(106.91985723035394,39.474522195597096), new Point(106.9218585719958,39.473692520041965), new Point(106.92404608495316,39.4740352133282), new Point(106.92486058445856,39.474684522256425), new Point(106.92518638426073,39.475820798180386)]

//            [new Point(107.04041904480762,39.65114357561267), new Point(107.03705880717436,39.64679062417564), new Point(107.03614539043457,39.64543895052591), new Point(107.03191833893139,39.64616219543931), new Point(107.02952762947469,39.64921581211213), new Point(107.03091354800034,39.657628697492214), new Point(107.03453349076958,39.6620612208715), new Point(107.03958543843864,39.66259717292914), new Point(107.04250764346288,39.66125728492871), new Point(107.04518220399356,39.658615714739206), new Point(107.04513267509485,39.65494031734131), new Point(107.04354775033592,39.651839047546645), new Point(107.04032837191936,39.65111156889202)]
//            [new Point(107.02250795943631,39.63531041501741), new Point(107.02385692436292,39.636233119320856), new Point(107.0263992044169,39.636874993257535), new Point(107.02894148447089,39.636393588367945), new Point(107.03132811472565,39.63575170992792), new Point(107.04061521941266,39.63282306335316), new Point(107.04424704806124,39.62688536566895), new Point(107.0406671026791,39.622070464002725), new Point(107.02380504109655,39.62355509469528), new Point(107.02058827857927,39.624718701712546), new Point(107.02250795943635,39.635110041384415)]
//            [new Point(107.03782209804757,39.64668777866282), new Point(107.03809296336479,39.64521556649449), new Point(107.03897943167568,39.645094995994654), new Point(107.03979202762734,39.64513941672978), new Point(107.04094115321554,39.64532979098305), new Point(107.04099040145502,39.64648471679405), new Point(107.04087548889619,39.64691906883877), new Point(107.0399479803857,39.646957142743844), new Point(107.03896301559583,39.64687464925612), new Point(107.03798625884585,39.64672235332583), new Point(107.03784672216729,39.64669062496444)]
//            [new Point(107.021621173599,39.64635448822788), new Point(107.02270498771657,39.64679001601012), new Point(107.02434013926182,39.646506567879946), new Point(107.02545030019598,39.64533352254567), new Point(107.02247334765661,39.64219476627665), new Point(107.02162836126622,39.64634700744285)]
//            [new Point(107.02247625236016,39.642176213342864), new Point(107.0239999499199,39.637407397728204), new Point(107.02593444576544,39.638223847518546), new Point(107.02752547236783,39.641838885204955), new Point(107.02843075441056,39.644789036597125), new Point(107.0254370937758,39.64533562504735), new Point(107.02246819216252,39.642191583326316)]
//            [new Point(107.02247363241547,39.642183841117834), new Point(107.02399271570545,39.63740948075738), new Point(107.02209082205137,39.635817258057614), new Point(107.02031301914963,39.63649786884222), new Point(107.0200889805139,39.6364671342952), new Point(107.01880799181025,39.64036171554092), new Point(107.02078006736104,39.64177339780462), new Point(107.02246651993266,39.64218338923799)]
//            [new Point(107.02843756365753,39.64478307726629), new Point(107.03114999915857,39.642333455622705), new Point(107.03539451063823,39.63966228045286), new Point(107.03539793742887,39.63966228045286), new Point(107.03544139690264,39.6372191478858), new Point(107.03376059806139,39.63676106375936), new Point(107.03124999048467,39.63754742414876), new Point(107.02976615106974,39.638344706932365), new Point(107.02898294562256,39.63966430237051), new Point(107.02882646030632,39.640994318161034), new Point(107.02753601738132,39.64184664046424), new Point(107.02753210978065,39.64184361926661), new Point(107.02843987652169,39.644792278349)]

    public static void main(String[] args) throws Exception {
//        final HashMap<String, List<Point>> Sites = new HashMap<String, List<Point>>();
////        Sites.put("利达采坑_采场",new ArrayList<>(new Point(106.93328130522411,39.47386315244423), new Point(106.93528591389676,39.47308331359599),new Point (106.93558002636611,39.47234545795724), new Point(106.93547166914055,39.47073774518093), new Point(106.9353913188517,39.470431795597676), (106.93582483034564,39.469644322307936), (106.9365670736119,39.4683526664651), (106.9367500924995,39.467012865038235), (106.9375533420616,39.46646117453912), (106.93967157860747,39.46445823047036), (106.94313265779039,39.465028145693694), (106.94430974405509,39.46563321920717), (106.94447081901762,39.46854326058364), (106.94432213443682,39.46923786471333), (106.94382651916747,39.46989091987866), (106.94301419554338,39.471726827036115), (106.94275399752698,39.47358987148918), (106.94080971381513,39.47393747936455), (106.94015302358324,39.47395668564973), (106.93959545640523,39.47434081023106), (106.93460105434576,39.47441544303832), (106.93349831037146,39.47424258742824)]
//        Sites.put("利达采坑_采场", Arrays.asList (new Point(106.93328130522411, 39.47386315244423), new Point(106.93528591389676, 39.47308331359599), new Point(106.93558002636611, 39.47234545795724), new Point(106.93547166914055, 39.47073774518093), new Point(106.9353913188517, 39.470431795597676), new Point(106.93582483034564, 39.469644322307936), new Point(106.9365670736119, 39.4683526664651), new Point(106.9367500924995, 39.467012865038235), new Point(106.9375533420616, 39.46646117453912), new Point(106.93967157860747, 39.46445823047036), new Point(106.94313265779039, 39.465028145693694), new Point(106.94430974405509, 39.46563321920717), new Point(106.94447081901762, 39.46854326058364), new Point(106.94432213443682, 39.46923786471333), new Point(106.94382651916747, 39.46989091987866), new Point(106.94301419554338, 39.471726827036115), new Point(106.94275399752698, 39.47358987148918), new Point(106.94080971381513, 39.47393747936455), new Point(106.94015302358324, 39.47395668564973), new Point(106.93959545640523, 39.47434081023106), new Point(106.93460105434576, 39.47441544303832), new Point(106.93349831037146, 39.47424258742824)));
//        Sites.put("利达东渣场", Arrays.asList (new Point(106.9334049552812,39.470530834676794), new Point(106.93354675275577,39.469585642519625), new Point(106.93390124644218,39.46786008391867), new Point(106.93479457053189,39.46806891177621), new Point(106.93500726674374,39.46816783001452), new Point(106.93490800851154,39.468563501550236), new Point(106.93476621103699,39.469420782096755), new Point(106.93461023381496,39.47050885361083), new Point(106.93459542740506,39.47058791229157), new Point(106.93400586054396,39.470581091918795), new Point(106.93344855853596,39.47056972462934), new Point(106.93340749417747,39.47056063079642)));
//
//        Sites.put("利达煤场渣场", Arrays.asList (new Point(106.94022939015291,39.47474585684117), new Point(106.94037848760337,39.47408718240309), new Point(106.94070650199441,39.47404673727657), new Point(106.94095251278769,39.474220073366126), new Point(106.94106433587555,39.47457829990489), new Point(106.94078105071965,39.47476896811081), new Point(106.94040830709346,39.47479785718694), new Point(106.94028157426057,39.47474007902256)));
//
//        Sites.put("利达排渣场", Arrays.asList (new Point(106.92520965567516,39.47603722956842), new Point(106.92388318505208,39.47679473408092), new Point(106.92297559988891,39.47690294833247), new Point(106.92048555854383,39.47585687012555), new Point(106.91985723035394,39.474522195597096), new Point(106.9218585719958,39.473692520041965), new Point(106.92404608495316,39.4740352133282), new Point(106.92486058445856,39.474684522256425), new Point(106.92518638426073,39.475820798180386)));
//
//        Sites.put("利达西渣场", Arrays.asList (new Point(107.04041904480762,39.65114357561267), new Point(107.03705880717436,39.64679062417564), new Point(107.03614539043457,39.64543895052591), new Point(107.03191833893139,39.64616219543931), new Point(107.02952762947469,39.64921581211213), new Point(107.03091354800034,39.657628697492214), new Point(107.03453349076958,39.6620612208715), new Point(107.03958543843864,39.66259717292914), new Point(107.04250764346288,39.66125728492871), new Point(107.04518220399356,39.658615714739206), new Point(107.04513267509485,39.65494031734131), new Point(107.04354775033592,39.651839047546645), new Point(107.04032837191936,39.65111156889202)));
//
//        Sites.put("蒙西北采区_采场", Arrays.asList (new Point(107.02250795943631,39.63531041501741), new Point(107.02385692436292,39.636233119320856), new Point(107.0263992044169,39.636874993257535), new Point(107.02894148447089,39.636393588367945), new Point(107.03132811472565,39.63575170992792), new Point(107.04061521941266,39.63282306335316), new Point(107.04424704806124,39.62688536566895), new Point(107.0406671026791,39.622070464002725), new Point(107.02380504109655,39.62355509469528), new Point(107.02058827857927,39.624718701712546), new Point(107.02250795943635,39.635110041384415)));
//
//        Sites.put("蒙西南采区_采场", Arrays.asList (new Point(107.03782209804757,39.64668777866282), new Point(107.03809296336479,39.64521556649449), new Point(107.03897943167568,39.645094995994654), new Point(107.03979202762734,39.64513941672978), new Point(107.04094115321554,39.64532979098305), new Point(107.04099040145502,39.64648471679405), new Point(107.04087548889619,39.64691906883877), new Point(107.0399479803857,39.646957142743844), new Point(107.03896301559583,39.64687464925612), new Point(107.03798625884585,39.64672235332583), new Point(107.03784672216729,39.64669062496444)));
//
//        Sites.put("蒙西煤场渣场", Arrays.asList (new Point(107.03782209804757,39.64668777866282), new Point(107.03809296336479,39.64521556649449), new Point(107.03897943167568,39.645094995994654), new Point(107.03979202762734,39.64513941672978), new Point(107.04094115321554,39.64532979098305), new Point(107.04099040145502,39.64648471679405), new Point(107.04087548889619,39.64691906883877), new Point(107.0399479803857,39.646957142743844), new Point(107.03896301559583,39.64687464925612), new Point(107.03798625884585,39.64672235332583), new Point(107.03784672216729,39.64669062496444)));
//
//        Sites.put("蒙西排土场1渣场", Arrays.asList (new Point(107.021621173599,39.64635448822788), new Point(107.02270498771657,39.64679001601012), new Point(107.02434013926182,39.646506567879946), new Point(107.02545030019598,39.64533352254567), new Point(107.02247334765661,39.64219476627665), new Point(107.02162836126622,39.64634700744285)));
//
//        Sites.put("蒙西排土场2渣场", Arrays.asList (new Point(107.02247625236016,39.642176213342864), new Point(107.0239999499199,39.637407397728204), new Point(107.02593444576544,39.638223847518546), new Point(107.02752547236783,39.641838885204955), new Point(107.02843075441056,39.644789036597125), new Point(107.0254370937758,39.64533562504735), new Point(107.02246819216252,39.642191583326316)));
//
//        Sites.put("蒙西排土场3渣场", Arrays.asList (new Point(107.02247363241547,39.642183841117834), new Point(107.02399271570545,39.63740948075738), new Point(107.02209082205137,39.635817258057614), new Point(107.02031301914963,39.63649786884222), new Point(107.0200889805139,39.6364671342952), new Point(107.01880799181025,39.64036171554092), new Point(107.02078006736104,39.64177339780462), new Point(107.02246651993266,39.64218338923799)));
//        Sites.put("蒙西排土场4渣场", Arrays.asList (new Point(107.02843756365753,39.64478307726629), new Point(107.03114999915857,39.642333455622705), new Point(107.03539451063823,39.63966228045286), new Point(107.03539793742887,39.63966228045286), new Point(107.03544139690264,39.6372191478858), new Point(107.03376059806139,39.63676106375936), new Point(107.03124999048467,39.63754742414876), new Point(107.02976615106974,39.638344706932365), new Point(107.02898294562256,39.63966430237051), new Point(107.02882646030632,39.640994318161034), new Point(107.02753601738132,39.64184664046424), new Point(107.02753210978065,39.64184361926661), new Point(107.02843987652169,39.644792278349)));
//
//        System.out.println(Sites);


//     [new Point(39.47386315244423,106.93328130522411), new Point(39.47308331359599,106.93528591389676), new Point(39.47234545795724,106.93558002636611), new Point(39.47073774518093,106.93547166914055), new Point(39.470431795597676,106.9353913188517), new Point(39.469644322307936,106.93582483034564), new Point(39.4683526664651,106.9365670736119), new Point(39.467012865038235,106.9367500924995), new Point(39.46646117453912,106.9375533420616), new Point(39.46445823047036,106.93967157860747), new Point(39.465028145693694,106.94313265779039), new Point(39.46563321920717,106.94430974405509), new Point(39.46854326058364,106.94447081901762), new Point(39.46923786471333,106.94432213443682), new Point(39.46989091987866,106.94382651916747), new Point(39.471726827036115,106.94301419554338), new Point(39.47358987148918,106.94275399752698), new Point(39.47393747936455,106.94080971381513), new Point(39.47395668564973,106.94015302358324), new Point(39.47434081023106,106.93959545640523), new Point(39.47441544303832,106.93460105434576), new Point(39.47424258742824,106.93349831037146)]
//[new Point(39.46553978194375,106.9445581367628), new Point(39.46583372115703,106.94457077701112), new Point(39.46825747067865,106.94468949570219), new Point(39.46923576392724,106.94455523527796), new Point(39.47190477444357,106.94342344555764), new Point(39.47359836788914,106.94356079521695), new Point(39.473956103776274,106.94936072366787), new Point(39.473449303851694,106.95378935879339), new Point(39.47256751203145,106.95717771050015), new Point(39.4690888767586,106.95806938200192), new Point(39.465909573308195,106.95673187474925), new Point(39.464408652893816,106.95479731001649), new Point(39.46415521834356,106.94876366618776), new Point(39.465399342663204,106.94469169966294)]
//
//        [new Point(39.470530834676794,106.9334049552812), new Point(39.469585642519625,106.93354675275577), new Point(39.46786008391867,106.93390124644218), new Point(39.46806891177621,106.93479457053189), new Point(39.46816783001452,106.93500726674374), new Point(39.468563501550236,106.93490800851154), new Point(39.469420782096755,106.93476621103699), new Point(39.47050885361083,106.93461023381496), new Point(39.47058791229157,106.93459542740506), new Point(39.470581091918795,106.93400586054396), new Point(39.47056972462934,106.93344855853596), new Point(39.47056063079642,106.93340749417747)]
//
//        [new Point(39.47474585684117,106.94022939015291), new Point(39.47408718240309,106.94037848760337), new Point(39.47404673727657,106.94070650199441), new Point(39.474220073366126,106.94095251278769), new Point(39.47457829990489,106.94106433587555), new Point(39.47476896811081,106.94078105071965), new Point(39.47479785718694,106.94040830709346), new Point(39.47474007902256,106.94028157426057)]
//[new Point(39.47603722956842,106.92520965567516), new Point(39.47679473408092,106.92388318505208), new Point(39.47690294833247,106.92297559988891), new Point(39.47585687012555,106.92048555854383), new Point(39.474522195597096,106.91985723035394), new Point(39.473692520041965,106.9218585719958), new Point(39.4740352133282,106.92404608495316), new Point(39.474684522256425,106.92486058445856), new Point(39.475820798180386,106.92518638426073)]
//
//        [new Point(39.65114357561267,107.04041904480762), new Point(39.64679062417564,107.03705880717436), new Point(39.64543895052591,107.03614539043457), new Point(39.64616219543931,107.03191833893139), new Point(39.64921581211213,107.02952762947469), new Point(39.657628697492214,107.03091354800034), new Point(39.6620612208715,107.03453349076958), new Point(39.66259717292914,107.03958543843864), new Point(39.66125728492871,107.04250764346288), new Point(39.658615714739206,107.04518220399356), new Point(39.65494031734131,107.04513267509485), new Point(39.651839047546645,107.04354775033592), new Point(39.65111156889202,107.04032837191936)]
//
//
//        [new Point(39.63531041501741,107.02250795943631), new Point(39.636233119320856,107.02385692436292), new Point(39.636874993257535,107.0263992044169), new Point(39.636393588367945,107.02894148447089), new Point(39.63575170992792,107.03132811472565), new Point(39.63282306335316,107.04061521941266), new Point(39.62688536566895,107.04424704806124), new Point(39.622070464002725,107.0406671026791), new Point(39.62355509469528,107.02380504109655), new Point(39.624718701712546,107.02058827857927), new Point(39.635110041384415,107.02250795943635)]
//[new Point(39.64668777866282,107.03782209804757), new Point(39.64521556649449,107.03809296336479), new Point(39.645094995994654,107.03897943167568), new Point(39.64513941672978,107.03979202762734), new Point(39.64532979098305,107.04094115321554), new Point(39.64648471679405,107.04099040145502), new Point(39.64691906883877,107.04087548889619), new Point(39.646957142743844,107.0399479803857), new Point(39.64687464925612,107.03896301559583), new Point(39.64672235332583,107.03798625884585), new Point(39.64669062496444,107.03784672216729)]
//[new Point(39.64635448822788,107.021621173599), new Point(39.64679001601012,107.02270498771657), new Point(39.646506567879946,107.02434013926182), new Point(39.64533352254567,107.02545030019598), new Point(39.64219476627665,107.02247334765661), new Point(39.64634700744285,107.02162836126622)]
//[new Point(39.642176213342864,107.02247625236016), new Point(39.637407397728204,107.0239999499199), new Point(39.638223847518546,107.02593444576544), new Point(39.641838885204955,107.02752547236783), new Point(39.644789036597125,107.02843075441056), new Point(39.64533562504735,107.0254370937758), new Point(39.642191583326316,107.02246819216252)]
//[new Point(39.642183841117834,107.02247363241547), new Point(39.63740948075738,107.02399271570545), new Point(39.635817258057614,107.02209082205137), new Point(39.63649786884222,107.02031301914963), new Point(39.6364671342952,107.0200889805139), new Point(39.64036171554092,107.01880799181025), new Point(39.64177339780462,107.02078006736104), new Point(39.64218338923799,107.02246651993266)]
//[new Point(39.64478307726629,107.02843756365753), new Point(39.642333455622705,107.03114999915857), new Point(39.63966228045286,107.03539451063823), new Point(39.63966228045286,107.03539793742887), new Point(39.6372191478858,107.03544139690264), new Point(39.63676106375936,107.03376059806139), new Point(39.63754742414876,107.03124999048467), new Point(39.638344706932365,107.02976615106974), new Point(39.63966430237051,107.02898294562256), new Point(39.640994318161034,107.02882646030632), new Point(39.64184664046424,107.02753601738132), new Point(39.64184361926661,107.02753210978065), new Point(39.644792278349,107.02843987652169)]


        final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();
        //设置水位线定期发射 五秒一次
        env.getConfig().setAutoWatermarkInterval(10000L);
//        env.setParallelism(1);
        //设置事务时间
        env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime);
        //source 数据源
        DataStreamSource<Car> carDataStreamSource = env.addSource(new SourceFromMySQL()).setParallelism(1);
//        carDataStreamSource.print();
        //map 提取重要信息
        SingleOutputStreamOperator<Tuple4<String, Long, Double, Double>> map = carDataStreamSource
                .map(new distanceCalculateRichMapFunction())
                //f分配时间戳和水位线
                .assignTimestampsAndWatermarks(WatermarkStrategy.forGenerator((context -> new DistancePeriodicGenerator()))
                        .withTimestampAssigner((event, recordTimestamp) -> event.f1)
                );
//            map.print();
        SingleOutputStreamOperator<CarLocationInfo> result = map.keyBy(s -> s.f0)
                //分成20秒的滚动窗口
                .window(TumblingEventTimeWindows.of(Time.seconds(20)))//Timewindow(Time.seconds(10))
                //watermark 触发窗口处理函数
                .process(
//                        new distanceProcessWindowFunction());

                    new ProcessWindowFunction<Tuple4<String, Long, Double, Double>, CarLocationInfo, String, TimeWindow>()
                    {
                        HashMap<String, List<Point>> Sites = new HashMap<String, List<Point>>();
                        private ValueState<String> lastLocation;
                        ////运输的次数
                        private ValueState<Integer> count;
            @Override
            public void open(Configuration parameters) throws Exception {
            super.open(parameters);
                ValueStateDescriptor<String> last_locationdescriptor = new ValueStateDescriptor<String>("last_location", TypeInformation.of(String.class));
                lastLocation = getRuntimeContext().getState(last_locationdescriptor);
                ValueStateDescriptor<Integer> countdescriptor = new ValueStateDescriptor<Integer>("count", TypeInformation.of(Integer.class),0);
                count = getRuntimeContext().getState(countdescriptor);
//                HashMap<String, List<Point>> Sites = new HashMap<String, List<Point>>();
//        Sites.put("利达采坑_采场",new ArrayList<>(new Point(106.93328130522411,39.47386315244423), new Point(106.93528591389676,39.47308331359599),new Point (106.93558002636611,39.47234545795724), new Point(106.93547166914055,39.47073774518093), new Point(106.9353913188517,39.470431795597676), (106.93582483034564,39.469644322307936), (106.9365670736119,39.4683526664651), (106.9367500924995,39.467012865038235), (106.9375533420616,39.46646117453912), (106.93967157860747,39.46445823047036), (106.94313265779039,39.465028145693694), (106.94430974405509,39.46563321920717), (106.94447081901762,39.46854326058364), (106.94432213443682,39.46923786471333), (106.94382651916747,39.46989091987866), (106.94301419554338,39.471726827036115), (106.94275399752698,39.47358987148918), (106.94080971381513,39.47393747936455), (106.94015302358324,39.47395668564973), (106.93959545640523,39.47434081023106), (106.93460105434576,39.47441544303832), (106.93349831037146,39.47424258742824)]
                Sites.put("利达采坑_采场", Arrays.asList (new Point(39.47386315244423,106.93328130522411), new Point(39.47308331359599,106.93528591389676), new Point(39.47234545795724,106.93558002636611), new Point(39.47073774518093,106.93547166914055), new Point(39.470431795597676,106.9353913188517), new Point(39.469644322307936,106.93582483034564), new Point(39.4683526664651,106.9365670736119), new Point(39.467012865038235,106.9367500924995), new Point(39.46646117453912,106.9375533420616), new Point(39.46445823047036,106.93967157860747), new Point(39.465028145693694,106.94313265779039), new Point(39.46563321920717,106.94430974405509), new Point(39.46854326058364,106.94447081901762), new Point(39.46923786471333,106.94432213443682), new Point(39.46989091987866,106.94382651916747), new Point(39.471726827036115,106.94301419554338), new Point(39.47358987148918,106.94275399752698), new Point(39.47393747936455,106.94080971381513), new Point(39.47395668564973,106.94015302358324), new Point(39.47434081023106,106.93959545640523), new Point(39.47441544303832,106.93460105434576), new Point(39.47424258742824,106.93349831037146)));

                Sites.put("利达东渣场", Arrays.asList (
                        new Point(39.46553978194375,106.9445581367628), new Point(39.46583372115703,106.94457077701112), new Point(39.46825747067865,106.94468949570219), new Point(39.46923576392724,106.94455523527796), new Point(39.47190477444357,106.94342344555764), new Point(39.47359836788914,106.94356079521695), new Point(39.473956103776274,106.94936072366787), new Point(39.473449303851694,106.95378935879339), new Point(39.47256751203145,106.95717771050015), new Point(39.4690888767586,106.95806938200192), new Point(39.465909573308195,106.95673187474925), new Point(39.464408652893816,106.95479731001649), new Point(39.46415521834356,106.94876366618776), new Point(39.465399342663204,106.94469169966294)));

                Sites.put("利达煤场渣场", Arrays.asList (
                        new Point(39.470530834676794,106.9334049552812), new Point(39.469585642519625,106.93354675275577), new Point(39.46786008391867,106.93390124644218), new Point(39.46806891177621,106.93479457053189), new Point(39.46816783001452,106.93500726674374), new Point(39.468563501550236,106.93490800851154), new Point(39.469420782096755,106.93476621103699), new Point(39.47050885361083,106.93461023381496), new Point(39.47058791229157,106.93459542740506), new Point(39.470581091918795,106.93400586054396), new Point(39.47056972462934,106.93344855853596), new Point(39.47056063079642,106.93340749417747)));

                Sites.put("利达排渣场", Arrays.asList (
                        new Point(39.47474585684117,106.94022939015291), new Point(39.47408718240309,106.94037848760337), new Point(39.47404673727657,106.94070650199441), new Point(39.474220073366126,106.94095251278769), new Point(39.47457829990489,106.94106433587555), new Point(39.47476896811081,106.94078105071965), new Point(39.47479785718694,106.94040830709346), new Point(39.47474007902256,106.94028157426057)));

                Sites.put("利达西渣场", Arrays.asList (
                        new Point(39.47603722956842,106.92520965567516), new Point(39.47679473408092,106.92388318505208), new Point(39.47690294833247,106.92297559988891), new Point(39.47585687012555,106.92048555854383), new Point(39.474522195597096,106.91985723035394), new Point(39.473692520041965,106.9218585719958), new Point(39.4740352133282,106.92404608495316), new Point(39.474684522256425,106.92486058445856), new Point(39.475820798180386,106.92518638426073)));

                Sites.put("蒙西北采区_采场", Arrays.asList (
                        new Point(39.65114357561267,107.04041904480762), new Point(39.64679062417564,107.03705880717436), new Point(39.64543895052591,107.03614539043457), new Point(39.64616219543931,107.03191833893139), new Point(39.64921581211213,107.02952762947469), new Point(39.657628697492214,107.03091354800034), new Point(39.6620612208715,107.03453349076958), new Point(39.66259717292914,107.03958543843864), new Point(39.66125728492871,107.04250764346288), new Point(39.658615714739206,107.04518220399356), new Point(39.65494031734131,107.04513267509485), new Point(39.651839047546645,107.04354775033592), new Point(39.65111156889202,107.04032837191936)));

                Sites.put("蒙西南采区_采场", Arrays.asList (
                        new Point(39.63531041501741,107.02250795943631), new Point(39.636233119320856,107.02385692436292), new Point(39.636874993257535,107.0263992044169), new Point(39.636393588367945,107.02894148447089), new Point(39.63575170992792,107.03132811472565), new Point(39.63282306335316,107.04061521941266), new Point(39.62688536566895,107.04424704806124), new Point(39.622070464002725,107.0406671026791), new Point(39.62355509469528,107.02380504109655), new Point(39.624718701712546,107.02058827857927), new Point(39.635110041384415,107.02250795943635)));

                Sites.put("蒙西煤场渣场", Arrays.asList (
                        new Point(39.64668777866282,107.03782209804757), new Point(39.64521556649449,107.03809296336479), new Point(39.645094995994654,107.03897943167568), new Point(39.64513941672978,107.03979202762734), new Point(39.64532979098305,107.04094115321554), new Point(39.64648471679405,107.04099040145502), new Point(39.64691906883877,107.04087548889619), new Point(39.646957142743844,107.0399479803857), new Point(39.64687464925612,107.03896301559583), new Point(39.64672235332583,107.03798625884585), new Point(39.64669062496444,107.03784672216729)));

                Sites.put("蒙西排土场1渣场", Arrays.asList (
                        new Point(39.64635448822788,107.021621173599), new Point(39.64679001601012,107.02270498771657), new Point(39.646506567879946,107.02434013926182), new Point(39.64533352254567,107.02545030019598), new Point(39.64219476627665,107.02247334765661), new Point(39.64634700744285,107.02162836126622)));

                Sites.put("蒙西排土场2渣场", Arrays.asList (
                        new Point(39.642176213342864,107.02247625236016), new Point(39.637407397728204,107.0239999499199), new Point(39.638223847518546,107.02593444576544), new Point(39.641838885204955,107.02752547236783), new Point(39.644789036597125,107.02843075441056), new Point(39.64533562504735,107.0254370937758), new Point(39.642191583326316,107.02246819216252)));

                Sites.put("蒙西排土场3渣场", Arrays.asList (
                        new Point(39.642183841117834,107.02247363241547), new Point(39.63740948075738,107.02399271570545), new Point(39.635817258057614,107.02209082205137), new Point(39.63649786884222,107.02031301914963), new Point(39.6364671342952,107.0200889805139), new Point(39.64036171554092,107.01880799181025), new Point(39.64177339780462,107.02078006736104), new Point(39.64218338923799,107.02246651993266)));
                Sites.put("蒙西排土场4渣场", Arrays.asList (
                        new Point(39.64478307726629,107.02843756365753), new Point(39.642333455622705,107.03114999915857), new Point(39.63966228045286,107.03539451063823), new Point(39.63966228045286,107.03539793742887), new Point(39.6372191478858,107.03544139690264), new Point(39.63676106375936,107.03376059806139), new Point(39.63754742414876,107.03124999048467), new Point(39.638344706932365,107.02976615106974), new Point(39.63966430237051,107.02898294562256), new Point(39.640994318161034,107.02882646030632), new Point(39.64184664046424,107.02753601738132), new Point(39.64184361926661,107.02753210978065), new Point(39.644792278349,107.02843987652169)));

        }

            @Override
            public void close() throws Exception {
            super.close();
        }
            //窗口处理函数
            @Override
            public void process(String s, ProcessWindowFunction<Tuple4<String, Long, Double, Double>, CarLocationInfo, String, TimeWindow>.Context context, Iterable<Tuple4<String, Long, Double, Double>> elements, Collector<CarLocationInfo> out) throws Exception {
            //定义上一条数据时间和当前数据时间


                String terminal_phone="";
                Long time=0L;
                Double latitude = 0D;
                Double longitude = 0D;
                String key1 = "区域外";
                boolean b = false;
            for (Tuple4<String, Long, Double, Double> ele : elements) {
                terminal_phone = ele.f0;
                time = ele.f1;
                latitude = ele.f2;
                longitude = ele.f3;


                Point check = new Point( latitude,longitude);

                boolean flag = false;
                for (Map.Entry<String, List<Point>> entry : Sites.entrySet()) {
                    String key = entry.getKey();

                    List<Point> list = entry.getValue();
//                                    System.out.println(list);

                    b = IsInPolygon(check, list);

                    if (b) {

                        key1 = key;
                        if(terminal_phone.equals("11640840055"))
                        System.out.println("当前终端号为" + terminal_phone +"当前所在区域"+key+"上一次所在区域" + lastLocation.value()+ "当前时间" + time + "当前已经运输次数" + count.value() + " 区域");

                        String lastlocation = lastLocation.value();
                        flag = true;
                        if(lastlocation==null){
                            if(key.contains("采场"))
                                lastLocation.update("采场");
                            if(key.contains("渣场"))
                                lastLocation.update("渣场");
                        }
                        else if(lastlocation=="采场"){
                          {
                                if(key.contains("渣场")){
                                    count.update(count.value()+1);
//                                    lastLocation.update("渣场");
//                                    System.out.println("111当前终端号为" + terminal_phone +"当前所在区域"+key+"上一次所在区域" + lastLocation.value()+ "当前时间" + time + "当前已经运输次数" + count.value() + " 区域");
                                    lastLocation.update("渣场");
//                                    System.out.println("当前终端号为" + terminal_phone +"当前所在区域"+key+"上一次所在区域" + lastLocation.value()+ "当前时间" + time );

                                }
                            }
                        }
                        else if(lastlocation=="渣场"){
                            if(key.contains("采场")) {
                                lastLocation.update("采场");
                            }
                        }
//                        System.out.println("当前终端号为" + terminal_phone + "当前时间" + time + "此数据点在" + key + " 区域");

//                        out.collect(new CarLocationInfo(terminal_phone,time,latitude,longitude,key,lastLocation.value(),count.value()));

                                        break;
                    }
//                    else{
//                        out.collect(new CarLocationInfo(terminal_phone,time,latitude,longitude,null,"区域外",count.value()));
//
//                    }
                }


//                System.out.println("当前数据结束");
//                if (!flag) {
//                    System.out.println("都不在这些区域");
//                }
            }
//            if(b){
                if(key1.contains("区域外"))
                    out.collect(new CarLocationInfo(s,time,latitude,longitude,key1, "区域外", count.value()));
                else
                    out.collect(new CarLocationInfo(s,time,latitude,longitude,key1, lastLocation.value(),count.value()));

//            }
//             else{
//                out.collect(new CarLocationInfo(s,time,latitude,longitude,key, lastLocation.value(), count.value()));
//            }

            }

            public Boolean IsInPolygon(Point checkPoint, List<Point> polygonPoints){
                Boolean inside = false;
                int pointCount = polygonPoints.size();
                Point p1, p2;
                for (int i = 0, j = pointCount - 1; i < pointCount; j = i, i++)//第一个点和最后一个点作为第一条线，之后是第一个点和第二个点作为第二条线，之后是第二个点与第三个点，第三个点与第四个点...
                {
                    p1 = polygonPoints.get(i);
                    p2 = polygonPoints.get(j);
                    if (checkPoint.getLongitude() < p2.getLongitude())
                    {//p2在射线之上
                        if (p1.getLongitude() <= checkPoint.getLongitude())
                        {//p1正好在射线中或者射线下方
                            if ((checkPoint.getLongitude() - p1.getLongitude()) * (p2.getLatitude() - p1.getLatitude()) > (checkPoint.getLatitude() - p1.getLatitude()) * (p2.getLongitude() - p1.getLongitude()))//斜率判断,在P1和P2之间且在P1P2右侧
                            {
                                //射线与多边形交点为奇数时则在多边形之内，若为偶数个交点时则在多边形之外。
                                //由于inside初始值为false，即交点数为零。所以当有第一个交点时，则必为奇数，则在内部，此时为inside=(!inside)
                                //所以当有第二个交点时，则必为偶数，则在外部，此时为inside=(!inside)
                                inside = (!inside);
                            }
                        }
                    }
                    else if (checkPoint.getLongitude() < p1.getLongitude())
                    {
                        //p2正好在射线中或者在射线下方，p1在射线上
                        if ((checkPoint.getLongitude() - p1.getLongitude()) * (p2.getLatitude() - p1.getLatitude()) < (checkPoint.getLatitude() - p1.getLatitude()) * (p2.getLongitude() - p1.getLongitude()))//斜率判断,在P1和P2之间且在P1P2右侧
                        {
                            inside = (!inside);
                        }
                    }
                }
                return inside;
            }

        }
        ).setParallelism(1);
//        result.print();
        result.addSink(new HBaseSink()).setParallelism(1);
//        result.addSink(new JDBCSinkCarLocation()).setParallelism(1);


        env.execute();
    }



}
